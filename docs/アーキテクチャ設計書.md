# アーキテクチャ設計書：airc (AI Resource Configurator)

## 1. システム概要

### 1.1 目的

airc は、GitHub リポジトリに保存された AI ツール設定ファイル（GitHub Copilot、Claude）を、ローカルプロジェクトにダウンロード・同期するための CLI ツールです。

### 1.2 システム全体像

```
┌─────────────┐
│   ユーザー   │
└──────┬──────┘
       │ npx実行（例: npx @maru3460/airc）
       │ プロファイル指定なし = default
       ↓
┌─────────────────────────────────┐
│  CLI Tool (Node.js)             │
│  ┌───────────────────────────┐  │
│  │ コマンドライン解析        │  │
│  │ (project = "default")     │  │
│  └───────┬───────────────────┘  │
│          ↓                      │
│  ┌───────────────────────────┐  │
│  │ GitHub API 呼び出し       │  │
│  │ (ファイルリスト取得)      │  │
│  └───────┬───────────────────┘  │
│          ↓                      │
│  ┌───────────────────────────┐  │
│  │ ファイルダウンロード制御  │  │
│  └───────┬───────────────────┘  │
│          ↓                      │
│  ┌───────────────────────────┐  │
│  │ ファイルシステム操作      │  │
│  └───────────────────────────┘  │
└──────────┬──────────────────────┘
           │
           ↓
┌──────────────────────────────────┐
│ GitHub API                       │
│ (api.github.com)                 │
│ - ファイルリスト取得             │
│ - ディレクトリ構造取得（再帰）   │
│ - 認証不要（Public リポジトリ）  │
└──────────┬───────────────────────┘
           │
           ↓
┌──────────────────────────────────┐
│ GitHub Repository                │
│ (raw.githubusercontent.com)      │
│ - 実ファイルのダウンロード       │
└──────────┬───────────────────────┘
           │
           ↓
┌──────────────────────────────────┐
│ ローカルファイルシステム         │
│ .github/, .claude/, etc.         │
└──────────────────────────────────┘
```

### 1.3 技術スタック

- **言語**: JavaScript (ESM)
- **ランタイム**: Node.js 18.0.0+
- **依存関係**: Node.js 標準ライブラリのみ
- **配布方法**: npm package
- **GitHub API**: 認証不要（Public リポジトリ前提）
  - レート制限: 60 リクエスト/時間（未認証）

## 2. 処理フロー

### 2.1 メイン処理フロー

```
開始
 ↓
コマンドライン引数解析
 ├→ プロファイル指定なし → profile = "default"
 └→ --profile <name> → profile = <name>
 ↓
特殊コマンド判定
 ├→ --help → ヘルプ表示 → 終了
 └→ それ以外 ↓
GitHub API でプロファイル存在確認
 (GET /repos/{owner}/{repo}/contents/profiles/{profile})
 ↓
プロファイル配下のファイルリストを再帰的に取得
 (GitHub API で全ディレクトリを走査)
 ↓
各ファイルに対してダウンロード処理
 ↓
結果表示
 ↓
終了
```

### 2.2 ファイルリスト取得フロー（GitHub API）

```
getProfileFiles(owner, repo, profile)
 ↓
GitHub API にリクエスト
 GET /repos/{owner}/{repo}/contents/profiles/{profile}
 ↓
レスポンス解析
 ├→ ファイル → ファイルリストに追加
 └→ ディレクトリ → 再帰的に取得（サブディレクトリを走査）
 ↓
全ファイルパスのリストを返す
 例: [
   "profiles/default/.github/chatmodes/file1.md",
   "profiles/default/.claude/instructions.md",
   "profiles/default/CLAUDE.md"
 ]
```

### 2.3 ファイルダウンロード処理フロー

```
downloadFile(filePath, force)
 ↓
raw.githubusercontent.com の URL 生成
 https://raw.githubusercontent.com/{owner}/{repo}/main/{filePath}
 ↓
ローカルパス生成
 profiles/default/.github/chatmodes/file.md
 → .github/chatmodes/file.md (profiles/{profile}/ を除去)
 ↓
ファイル存在チェック
 ├→ 存在しない → ダウンロード実行へ
 └→ 存在する
      ├→ force=true → ダウンロード実行へ
      └→ force=false → 上書き確認
           ├→ Yes → ダウンロード実行へ
           └→ No → スキップ
 ↓
ディレクトリ作成（必要な場合）
 ↓
HTTP GET リクエスト実行
 ↓
レスポンス確認
 ├→ 成功 → ファイル書き込み → 成功メッセージ
 └→ 失敗 → エラーメッセージ
 ↓
終了
```

## 3. データフロー

### 3.1 データの流れ

```
コマンドライン引数
       ↓
引数解析オブジェクト
{
  profile: string (default: "default"),
  force: boolean
}
       ↓
GitHub API 呼び出し
  GET /repos/{owner}/{repo}/contents/profiles/{profile}
       ↓
ファイルリスト取得（再帰的）
  ["profiles/default/.github/chatmodes/file.md", ...]
       ↓
各ファイルに対して:
  raw.githubusercontent.com URL 構築
       ↓
  HTTP GET リクエスト
       ↓
  レスポンスボディ
       ↓
  ローカルパス変換
    profiles/default/.github/chatmodes/file.md
    → .github/chatmodes/file.md
       ↓
  ローカルファイルに書き込み
```

### 3.2 プロファイル構造

```
リポジトリ構造:
profiles/
├── default/           ← デフォルトプロファイル
│   ├── .github/
│   │   ├── chatmodes/*.md
│   │   └── prompts/*.md
│   ├── .claude/
│   │   └── instructions/*.md
│   └── CLAUDE.md
├── profileA/          ← カスタムプロファイル
│   └── (同様の構造)
└── profileB/
    └── (同様の構造)

GitHub API で動的にファイルリストを取得するため、
コード内でのファイル定義は不要
```

## 4. エラー処理戦略

### 4.1 エラー分類と処理方針

| エラー種別                 | 検出タイミング      | 処理方針             | ユーザーへの通知                   |
| -------------------------- | ------------------- | -------------------- | ---------------------------------- |
| 不正なプロファイル名       | GitHub API 呼び出し | 処理中断             | エラーメッセージ（404 エラー）     |
| GitHub API レート制限超過  | GitHub API 呼び出し | 処理中断             | レート制限エラー + 待機時間表示    |
| GitHub API エラー          | GitHub API 呼び出し | 処理中断             | エラーメッセージ                   |
| ファイル未発見             | ダウンロード時      | 該当ファイルスキップ | エラーメッセージ                   |
| ネットワークエラー         | HTTP リクエスト時   | 該当ファイルスキップ | エラーメッセージ                   |
| 書き込みエラー             | ファイル保存時      | 該当ファイルスキップ | エラーメッセージ                   |

### 4.2 エラーハンドリングの原則

- **部分的な失敗を許容**: 一部のファイルがダウンロード失敗しても処理を継続
- **明確なエラーメッセージ**: 何が失敗したか、なぜ失敗したかを明示
- **リカバリー情報の提供**: エラー時に次に取るべきアクションを提示

## 5. セキュリティ設計

### 5.1 入力バリデーション

- プロファイル名の検証（既知のプロファイルのみ許可）
- ファイル名の検証（ディレクトリトラバーサル防止）
- パスインジェクション対策

### 5.2 ネットワークセキュリティ

- HTTPS 通信のみ
- api.github.com と raw.githubusercontent.com への接続に限定
- リダイレクトの制限
- 認証トークン不要（Public リポジトリ前提）

### 5.3 ファイルシステムセキュリティ

- 書き込み先の制限（作業ディレクトリ配下のみ）
- シンボリックリンクの扱い

## 6. 運用設計

### 6.1 バージョニング戦略

- メジャーバージョン: 破壊的変更
- マイナーバージョン: 機能追加
- パッチバージョン: バグ修正

### 6.2 リリースフロー

1. 変更のコミット
2. バージョン番号更新（`npm version`）
3. npm 公開（`npm publish`）
4. GitHub リリースタグ作成
