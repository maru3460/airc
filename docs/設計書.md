# 設計書：airc (AI Resource Configurator)

## 1. システム概要

### 1.1 アーキテクチャ概要

```
┌─────────────┐
│   ユーザー   │
└──────┬──────┘
       │ npx実行
       ↓
┌─────────────────────────────┐
│  CLI Tool (Node.js)         │
│  ┌───────────────────────┐  │
│  │ コマンドライン解析    │  │
│  └───────┬───────────────┘  │
│          ↓                  │
│  ┌───────────────────────┐  │
│  │ ダウンロード制御      │  │
│  └───────┬───────────────┘  │
│          ↓                  │
│  ┌───────────────────────┐  │
│  │ ファイルシステム操作  │  │
│  └───────────────────────┘  │
└──────────┬──────────────────┘
           │
           ↓
┌─────────────────────────────┐
│ GitHub Repository           │
│ (raw.githubusercontent.com) │
└─────────────────────────────┘
           │
           ↓
┌─────────────────────────────┐
│ ローカルファイルシステム    │
│ .github/, .claude/, etc.    │
└─────────────────────────────┘
```

### 1.2 技術スタック

- **言語**: JavaScript (ESM)
- **ランタイム**: Node.js 18.0.0+
- **依存関係**: Node.js 標準ライブラリのみ
- **配布方法**: npm package

## 2. モジュール設計

### 2.1 主要モジュール構成

```
bin/
└── cli.js          # メインエントリポイント
    ├── 設定定義
    ├── ユーティリティ関数
    ├── メイン処理
    └── エラーハンドリング
```

### 2.2 データ構造

#### 2.2.1 プロジェクト設定オブジェクト

```javascript
const PROJECT_FILES = {
  [projectName: string]: {
    chatmodes: string[],  // chatmodesファイルリスト
    prompts: string[],    // promptsファイルリスト
    claude: string[],     // .claudeファイルリスト
    root: string[]        // ルートファイルリスト
  }
}
```

#### 2.2.2 タイプパス設定オブジェクト

```javascript
const TYPE_PATHS = {
  chatmodes: string, // ".github/chatmodes"
  prompts: string, // ".github/prompts"
  claude: string, // ".claude"
  root: string, // "."
};
```

#### 2.2.3 コマンドライン引数構造

```javascript
{
  project: string,      // プロジェクト名 (default: "default")
  type: string | null,  // タイプ指定
  file: string | null,  // ファイル名指定
  force: boolean        // 強制上書きフラグ
}
```

## 3. 処理フロー設計

### 3.1 メイン処理フロー

```
開始
 ↓
コマンドライン引数解析
 ↓
引数バリデーション
 ↓
特殊コマンド判定
 ├→ --help → ヘルプ表示 → 終了
 ├→ --list-projects → プロジェクト一覧表示 → 終了
 └→ それ以外 ↓
プロジェクト存在確認
 ↓
ダウンロード対象決定
 ├→ --file指定 → 単一ファイルダウンロード
 ├→ --type指定 → タイプ別ダウンロード
 └→ 指定なし → 全ファイルダウンロード
 ↓
各ファイルに対してダウンロード処理
 ↓
結果表示
 ↓
終了
```

### 3.2 ファイルダウンロード処理フロー

```
downloadFile(project, type, filename, force)
 ↓
URL生成
 ├→ rootタイプ: projects/{project}/{filename}
 └→ その他: projects/{project}/{type_path}/{filename}
 ↓
ローカルパス生成
 ├→ rootタイプ: ./{filename}
 └→ その他: ./{type_path}/{filename}
 ↓
ファイル存在チェック
 ├→ 存在しない → ダウンロード実行へ
 └→ 存在する
      ├→ force=true → ダウンロード実行へ
      └→ force=false → 上書き確認
           ├→ Yes → ダウンロード実行へ
           └→ No → スキップ
 ↓
ディレクトリ作成（必要な場合）
 ↓
HTTPリクエスト実行
 ↓
レスポンス確認
 ├→ 成功 → ファイル書き込み → 成功メッセージ
 └→ 失敗 → エラーメッセージ
 ↓
終了
```

## 4. 関数設計

### 4.1 ユーティリティ関数

#### fileExists(path: string): Promise<boolean>

- **目的**: ファイルの存在確認
- **引数**: ファイルパス
- **戻り値**: 存在する場合 true
- **実装**: fs/promises の access を使用
- **エラー処理**: アクセスエラーを false として扱う

#### askOverwrite(filename: string): Promise<boolean>

- **目的**: 上書き確認プロンプト表示
- **引数**: ファイル名
- **戻り値**: 上書きする場合 true
- **実装**: readline インターフェース使用
- **入力**: y/N（デフォルト No）

### 4.2 コア関数

#### downloadFile(project, type, filename, force)

- **目的**: 単一ファイルのダウンロードと保存
- **引数**:
  - project: プロジェクト名
  - type: ファイルタイプ
  - filename: ファイル名
  - force: 強制上書きフラグ
- **処理**:
  1. URL 生成
  2. ローカルパス生成
  3. 存在チェック
  4. 上書き確認（必要な場合）
  5. ディレクトリ作成
  6. ダウンロード実行
  7. ファイル書き込み
- **エラー処理**:
  - HTTP エラー: エラーメッセージ表示して継続
  - 書き込みエラー: エラーメッセージ表示して継続

#### listProjects()

- **目的**: 利用可能なプロジェクト一覧表示
- **処理**:
  1. PROJECT_FILES オブジェクトを走査
  2. プロジェクト名と総ファイル数を表示
- **出力形式**:

```
📦 Available projects:

  • frontend
    (8 files)

  • backend
    (10 files)
```

#### showHelp()

- **目的**: ヘルプメッセージ表示
- **内容**:
  - 使用方法
  - オプション一覧と説明
  - 使用例

#### main()

- **目的**: メインエントリポイント
- **処理フロー**: 3.1 参照
- **エラー処理**: 最上位の catch-all エラーハンドリング

### 4.3 引数解析ロジック

```javascript
// 引数パース例
for (let i = 0; i < args.length; i++) {
  switch (args[i]) {
    case "-p":
    case "--project":
      project = args[++i];
      break;
    case "--type":
      type = args[++i];
      break;
    case "--file":
      specificFile = args[++i];
      break;
    case "-f":
    case "--force":
      force = true;
      break;
    case "--list-projects":
      listProjects();
      return;
    case "-h":
    case "--help":
      showHelp();
      return;
  }
}
```

## 5. URL 設計

### 5.1 GitHub リポジトリ URL 構造

```
ベースURL: https://raw.githubusercontent.com/maru3460/airc/main

ファイルパス構造:
- chatmodes: projects/{project}/.github/chatmodes/{filename}
- prompts:   projects/{project}/.github/prompts/{filename}
- claude:    projects/{project}/.claude/{filename}
- root:      projects/{project}/{filename}

例:
https://raw.githubusercontent.com/maru3460/airc/main/projects/frontend/.github/chatmodes/react-best-practices.md
```

### 5.2 ローカルパス構造

```
作業ディレクトリをルートとして:
- chatmodes: .github/chatmodes/{filename}
- prompts:   .github/prompts/{filename}
- claude:    .claude/{filename}
- root:      {filename}

例:
.github/chatmodes/react-best-practices.md
.claude/instructions.md
CLAUDE.md
```

## 6. エラー処理設計

### 6.1 エラー分類と処理方針

| エラー種別           | 検出タイミング    | 処理方針             | ユーザーへの通知                            |
| -------------------- | ----------------- | -------------------- | ------------------------------------------- |
| 不正なプロジェクト名 | 引数検証時        | 処理中断             | エラーメッセージ + 利用可能プロジェクト提示 |
| 不正なタイプ名       | ダウンロード前    | 該当タイプスキップ   | 警告メッセージ                              |
| ファイル未発見       | ダウンロード時    | 該当ファイルスキップ | エラーメッセージ                            |
| ネットワークエラー   | HTTP リクエスト時 | 該当ファイルスキップ | エラーメッセージ                            |
| 書き込みエラー       | ファイル保存時    | 該当ファイルスキップ | エラーメッセージ                            |

### 6.2 エラーメッセージ設計

```javascript
// エラーメッセージ例
const ERROR_MESSAGES = {
  UNKNOWN_PROJECT: (name) =>
    `❌ Unknown project: ${name}\n\nRun with --list-projects to see available projects`,

  UNKNOWN_TYPE: (type) => `❌ Unknown type: ${type}`,

  FILE_NOT_FOUND: (file, project) =>
    `❌ File not found in project ${project}: ${file}`,

  DOWNLOAD_FAILED: (file, reason) => `✗ Failed to download ${file}: ${reason}`,

  WRITE_FAILED: (file, reason) => `✗ Failed to write ${file}: ${reason}`,
};
```

## 7. 出力設計

### 7.1 進捗表示

```
標準出力の流れ:

🚀 Downloading configurations for project: frontend

📁 Downloading chatmodes...
✓ Downloaded: .github/chatmodes/react-best-practices.md
⊘ Skipped: .github/chatmodes/component-review.md
✗ Failed to download debugging.md: 404 Not Found

📁 Downloading prompts...
✓ Downloaded: .github/prompts/react-refactor.md
✓ Downloaded: .github/prompts/accessibility-check.md

✨ Done!
```

### 7.2 アイコン使用

- 🚀 処理開始
- 📁 タイプ別処理開始
- ✓ 成功
- ⊘ スキップ
- ✗ エラー
- ✨ 完了
- 📦 プロジェクト一覧
- ❌ 致命的エラー

## 8. package.json 設計

### 8.1 必須フィールド

```json
{
  "name": "@maru3460/airc",
  "version": "1.0.0",
  "description": "Download and sync AI tool configurations (GitHub Copilot, Claude)",
  "type": "module",
  "bin": {
    "airc": "./bin/cli.js"
  },
  "engines": {
    "node": ">=18.0.0"
  },
  "files": ["bin/"],
  "keywords": ["github-copilot", "claude", "chatmodes", "prompts", "cli", "airc"]
}
```

### 8.2 オプションフィールド

```json
{
  "repository": {
    "type": "git",
    "url": "https://github.com/maru3460/airc"
  },
  "author": "maru3460",
  "license": "MIT"
}
```

## 9. リポジトリ構造設計

### 9.1 推奨ディレクトリ構造

```
airc/
├── .gitignore
├── README.md
├── LICENSE
├── package.json
├── bin/
│   └── cli.js
└── projects/
    ├── default/
    │   ├── .github/
    │   │   ├── chatmodes/
    │   │   └── prompts/
    │   ├── .claude/
    │   └── CLAUDE.md
    ├── frontend/
    │   └── (同様の構造)
    └── backend/
        └── (同様の構造)
```

### 9.2 .gitignore 設計

```
node_modules/
*.log
.DS_Store
dist/
```

## 10. セキュリティ考慮事項

### 10.1 入力バリデーション

- プロジェクト名の検証（既知のプロジェクトのみ許可）
- ファイル名の検証（ディレクトリトラバーサル防止）
- パスインジェクション対策

### 10.2 ネットワークセキュリティ

- HTTPS 通信のみ
- raw.githubusercontent.com への接続に限定
- リダイレクトの制限

### 10.3 ファイルシステムセキュリティ

- 書き込み先の制限（作業ディレクトリ配下のみ）
- シンボリックリンクの扱い

## 11. テスト設計

### 11.1 ユニットテスト項目

| テスト対象   | テストケース                         |
| ------------ | ------------------------------------ |
| fileExists   | 存在するファイル、存在しないファイル |
| askOverwrite | y 入力、n 入力、空入力               |
| 引数解析     | 各オプションの正常系、異常系         |
| URL 生成     | 各タイプの URL 正当性                |
| パス生成     | 各タイプのローカルパス正当性         |

### 11.2 統合テスト項目

| テスト項目             | 検証内容                                   |
| ---------------------- | ------------------------------------------ |
| デフォルトダウンロード | 全ファイルダウンロード成功                 |
| プロジェクト指定       | 指定プロジェクトのファイルのみダウンロード |
| タイプ指定             | 指定タイプのファイルのみダウンロード       |
| ファイル指定           | 指定ファイルのみダウンロード               |
| 上書き確認             | 既存ファイルの上書き確認動作               |
| 強制上書き             | --force オプションでの上書き動作           |
| エラーハンドリング     | 各種エラー時の適切な処理                   |

## 12. 拡張性設計

### 12.1 プロジェクト追加方法

1. `PROJECT_FILES`オブジェクトに新規エントリ追加
2. リポジトリの`projects/`に対応ディレクトリ作成
3. 設定ファイル配置

### 12.2 新規タイプ追加方法

1. `TYPE_PATHS`に新規タイプのパス定義追加
2. `PROJECT_FILES`の各プロジェクトに新規タイプのフィールド追加
3. リポジトリ構造に対応ディレクトリ追加

### 12.3 将来の拡張候補

- 設定ファイルのバージョン管理
- 差分表示機能
- プライベートリポジトリ対応（認証機能）
- インタラクティブ UI（inquirer 等）
- 設定ファイルのバリデーション
- 複数リポジトリからの取得

## 13. パフォーマンス最適化

### 13.1 並列ダウンロード

現状は順次処理だが、将来的に Promise.all を使用して並列化可能

```javascript
await Promise.all(
  files.map((file) => downloadFile(project, type, file, force))
);
```

### 13.2 キャッシング

頻繁に使用される設定のローカルキャッシュ（将来対応）

## 14. 運用設計

### 14.1 バージョニング戦略

- メジャーバージョン: 破壊的変更
- マイナーバージョン: 機能追加
- パッチバージョン: バグ修正

### 14.2 リリースフロー

1. 変更のコミット
2. バージョン番号更新（`npm version`）
3. npm 公開（`npm publish`）
4. GitHub リリースタグ作成

### 14.3 監視項目

- ダウンロード失敗率
- 平均ダウンロード時間
- エラー発生頻度
