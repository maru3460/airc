# 仕組みを理解する

airc の内部構造と動作の仕組みを理解するためのドキュメントです。

## 全体アーキテクチャ

### 技術スタック

| 項目 | 技術 |
|------|------|
| **言語** | TypeScript (ES2022) |
| **ランタイム** | Node.js 18.0.0+ |
| **モジュール形式** | ESM（ES2022 Module） |
| **CLI パーサー** | yargs |
| **配布方式** | npm package (`@maru3460/airc`) |

### ディレクトリ構成

```
airc/
├── src/                    # TypeScript ソースコード
│   ├── cli.ts              # エントリポイント
│   ├── config.ts           # 設定定数
│   ├── types.ts            # 型定義
│   ├── cli/                # CLI 関連
│   │   ├── yargs.ts        # 引数解析
│   │   └── commands.ts     # コマンド実行
│   ├── github/             # GitHub 連携
│   │   ├── api.ts          # API 操作
│   │   └── download.ts     # ファイルダウンロード
│   └── utils/              # ユーティリティ
│       ├── path.ts         # パス操作
│       └── fs.ts           # ファイル操作
├── bin/                    # ビルド出力先（JavaScript）
├── profiles/               # 設定プロジェクト
│   ├── default/            # デフォルトプロジェクト
│   └── {profile}/          # カスタムプロファイル
├── scripts/                # ユーティリティスクリプト
│   └── generate-manifest.js # マニフェスト生成
├── package.json            # npm パッケージ設定
└── tsconfig.json           # TypeScript 設定
```

## 処理フロー

### メイン処理フロー

```
┌─────────────────────────┐
│ ユーザーがコマンド実行    │
│ $ npx airc -p my-profile │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│ 1. コマンドライン引数解析  │
│    (cli/yargs.ts)        │
│    - project: "my-profile" │
│    - force: false        │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│ 2. マニフェスト取得試行   │
│    (github/api.ts)       │
│    fetchManifest()      │
└───────────┬─────────────┘
            │
            ├─── 成功 ─────┐
            │               │
            │               ▼
            │    ┌────────────────────┐
            │    │ files.json を使用  │
            │    │ (効率的)           │
            │    └────────┬───────────┘
            │             │
            └─── 失敗 ───┐│
                         ││
                         ▼▼
            ┌─────────────────────────┐
            │ 3. ファイルリスト取得     │
            │    getProjectFiles()    │
            │    (フォールバック)      │
            └───────────┬─────────────┘
                        │
                        ▼
            ┌─────────────────────────┐
            │ 4. 各ファイルをループ処理 │
            └───────────┬─────────────┘
                        │
                        ▼
            ┌─────────────────────────┐
            │ 5. ファイルダウンロード   │
            │    downloadFile()       │
            │    - パス変換           │
            │    - 存在確認           │
            │    - 上書き確認         │
            │    - ダウンロード       │
            │    - 保存               │
            └───────────┬─────────────┘
                        │
                        ▼
            ┌─────────────────────────┐
            │ 6. 統計情報表示          │
            │    ✨ 完了!             │
            └─────────────────────────┘
```

### マニフェスト取得フロー

```
┌───────────────────────────────────────────┐
│ fetchManifest(project: "my-profile")      │
└────────────────┬──────────────────────────┘
                 │
                 ▼
┌───────────────────────────────────────────┐
│ URL 構築:                                  │
│ https://raw.githubusercontent.com/        │
│   maru3460/airc/main/                     │
│   profiles/my-profile/files.json          │
└────────────────┬──────────────────────────┘
                 │
                 ▼
┌───────────────────────────────────────────┐
│ HTTPS GET リクエスト                       │
└────────┬───────────────┬──────────────────┘
         │               │
    成功 (200)        失敗 (404)
         │               │
         ▼               ▼
┌─────────────┐   ┌──────────────┐
│ JSON パース  │   │ null を返す   │
│ Manifest 取得│   └──────────────┘
└─────────────┘
```

### ファイルダウンロードフロー

```
┌───────────────────────────────────────────┐
│ downloadFile(filePath, options)           │
└────────────────┬──────────────────────────┘
                 │
                 ▼
┌───────────────────────────────────────────┐
│ 1. パス変換                                │
│    toLocalPath()                          │
│    "profiles/my-profile/.github/..."      │
│    → ".github/..."                        │
└────────────────┬──────────────────────────┘
                 │
                 ▼
┌───────────────────────────────────────────┐
│ 2. パス検証                                │
│    isValidPath()                          │
│    "../" などを拒否                        │
└────────────────┬──────────────────────────┘
                 │
                 ▼
┌───────────────────────────────────────────┐
│ 3. ファイル存在確認                         │
│    fileExists()                           │
└────────┬────────────────┬─────────────────┘
         │                │
    存在しない         存在する
         │                │
         │                ▼
         │    ┌────────────────────────┐
         │    │ 4. 上書き確認           │
         │    │    (force=false の場合) │
         │    │    askOverwrite()      │
         │    └────────┬───────────────┘
         │             │
         │        ユーザー入力
         │             │
         │      ┌──────┴──────┐
         │      │             │
         │     Yes           No
         │      │             │
         │      │             ▼
         │      │      ┌──────────────┐
         │      │      │ スキップ      │
         │      │      │ return "skipped" │
         │      │      └──────────────┘
         │      │
         └──────┘
                │
                ▼
┌───────────────────────────────────────────┐
│ 5. ディレクトリ作成                         │
│    ensureDir()                            │
│    mkdir -p 相当                           │
└────────────────┬──────────────────────────┘
                 │
                 ▼
┌───────────────────────────────────────────┐
│ 6. ダウンロード                            │
│    https.get()                            │
│    https://raw.githubusercontent.com/...  │
└────────────────┬──────────────────────────┘
                 │
                 ▼
┌───────────────────────────────────────────┐
│ 7. ファイル保存                            │
│    saveFile()                             │
│    fs.writeFileSync()                     │
└────────────────┬──────────────────────────┘
                 │
                 ▼
┌───────────────────────────────────────────┐
│ return "success"                          │
└───────────────────────────────────────────┘
```

## 主要モジュールの詳細

### 1. config.ts - 設定定数

GitHub リポジトリ情報と API エンドポイントを定義します。

```typescript
export const REPO_OWNER = "maru3460";
export const REPO_NAME = "airc";
export const REPO_BRANCH = "main";
export const GITHUB_API_BASE = "https://api.github.com";
export const GITHUB_RAW_BASE = "https://raw.githubusercontent.com";
export const DEFAULT_PROJECT = "default";
```

### 2. types.ts - 型定義

TypeScript の型定義を一元管理します。

```typescript
// コマンドラインオプション
export interface CliOptions {
  profile: string;    // プロファイル名
  force: boolean;     // 強制上書きフラグ
  help: boolean;      // ヘルプ表示フラグ
}

// マニフェストファイルの構造
export interface Manifest {
  version: string;    // マニフェストバージョン
  files: string[];    // ファイルパスのリスト
}

// ダウンロード結果
export type DownloadResult = 'success' | 'skipped' | 'error';

// ダウンロード統計
export interface DownloadStats {
  success: number;    // 成功数
  skipped: number;    // スキップ数
  error: number;      // エラー数
}
```

### 3. cli/yargs.ts - 引数解析

yargs ライブラリを使用してコマンドライン引数を解析します。

```typescript
export function parseArgs(): CliOptions {
  const argv = yargs(process.argv.slice(2))
    .option('profile', {
      type: 'string',
      default: DEFAULT_PROJECT,
      description: 'ダウンロードするプロファイルを指定'
    })
    .option('force', {
      alias: 'f',
      type: 'boolean',
      default: false,
      description: '確認なしで上書き'
    })
    .help()
    .alias('help', 'h')
    .parseSync();

  return {
    profile: argv.profile,
    force: argv.force,
    help: argv.help || false
  };
}
```

### 4. github/api.ts - GitHub API 操作

#### マニフェスト取得

```typescript
export async function fetchManifest(profile: string): Promise<Manifest | null> {
  const url = `${GITHUB_RAW_BASE}/${REPO_OWNER}/${REPO_NAME}/${REPO_BRANCH}/profiles/${profile}/files.json`;

  try {
    const response = await fetch(url);
    if (!response.ok) return null;

    const manifest: Manifest = await response.json();
    return manifest;
  } catch (error) {
    return null;
  }
}
```

#### ファイルリスト取得（フォールバック）

```typescript
export async function getProfileFiles(profile: string): Promise<string[]> {
  const url = `${GITHUB_API_BASE}/repos/${REPO_OWNER}/${REPO_NAME}/contents/profiles/${profile}`;

  // GitHub API を使って再帰的にファイルリストを取得
  // ...
}
```

### 5. utils/path.ts - パス操作

#### パス検証

```typescript
export function isValidPath(path: string): boolean {
  // ディレクトリトラバーサル攻撃を防止
  return !path.includes('../');
}
```

#### パス変換

```typescript
export function toLocalPath(githubPath: string, profile: string): string {
  // "profiles/my-profile/.github/prompts/sample.md"
  // → ".github/prompts/sample.md"
  const prefix = `profiles/${profile}/`;
  if (githubPath.startsWith(prefix)) {
    return githubPath.substring(prefix.length);
  }
  return githubPath;
}
```

### 6. utils/fs.ts - ファイル操作

#### ディレクトリ作成

```typescript
export function ensureDir(dirPath: string): void {
  if (!fs.existsSync(dirPath)) {
    fs.mkdirSync(dirPath, { recursive: true });
  }
}
```

#### 上書き確認

```typescript
export async function askOverwrite(filePath: string): Promise<boolean> {
  console.log(`⚠️  ファイルが既に存在します: ${filePath}`);

  // ユーザーに確認を求める
  const answer = await prompt('上書きしますか？ (y/n): ');

  return answer.toLowerCase() === 'y';
}
```

## マニフェストファイル（files.json）

### 目的

マニフェストファイルは、ダウンロード対象のファイルリストを定義します。
これにより、GitHub API のリクエスト数を削減できます。

### 構造

```json
{
  "version": "1.0",
  "files": [
    ".github/chatmodes/sample.chatmode.md",
    ".github/prompts/code-review.prompt.md",
    ".claude/instructions.md",
    "CLAUDE.md"
  ]
}
```

### 自動生成の仕組み

`scripts/generate-manifest.js` が各プロジェクトのファイルリストを走査し、`files.json` を生成します。

```javascript
// 各プロジェクトについて
for (const profile of profiles) {
  // ファイルリストを取得
  const files = await getFiles(`profiles/${profile}`);

  // files.json を生成
  const manifest = {
    version: "1.0",
    files: files.sort()
  };

  // 保存
  fs.writeFileSync(
    `profiles/${profile}/files.json`,
    JSON.stringify(manifest, null, 2)
  );
}
```

### Git Hook による自動実行

`package.json` で pre-commit hook を設定しています：

```json
{
  "simple-git-hooks": {
    "pre-commit": "node scripts/generate-manifest.js && git add profiles/**/files.json"
  }
}
```

**動作:**
1. `git commit` 実行
2. pre-commit hook が自動実行
3. `generate-manifest.js` がマニフェストを生成
4. 生成されたファイルを自動的に staging area に追加
5. コミット完了

## セキュリティ設計

### 1. ディレクトリトラバーサル防止

```typescript
export function isValidPath(path: string): boolean {
  // "../" を含むパスを拒否
  return !path.includes('../');
}
```

**攻撃例の防止:**
```
悪意のあるパス: "../../etc/passwd"
→ isValidPath() が false を返して拒否
```

### 2. HTTPS 通信のみ

すべての通信は HTTPS で行われます：
- GitHub API: `https://api.github.com`
- ファイルダウンロード: `https://raw.githubusercontent.com`

### 3. 書き込み先の制限

ファイルはカレントディレクトリ配下にのみ保存されます。

```typescript
const localPath = toLocalPath(githubPath, profile);
// localPath は常に相対パス（例: ".github/prompts/sample.md"）
```

## パフォーマンス最適化

### マニフェスト方式

**従来の方法（再帰的取得）:**
- プロジェクトディレクトリごとに 1 リクエスト
- サブディレクトリごとに 1 リクエスト
- 合計: 5〜10 リクエスト

**マニフェスト方式:**
- `files.json` の取得に 1 リクエスト
- 合計: 1 リクエスト

**効果:**
- API リクエスト数を 80〜90% 削減
- レート制限（60 リクエスト/時間）に達するリスクをほぼゼロに

## ビルドプロセス

### TypeScript → JavaScript

```bash
# ビルドコマンド
npm run build

# 実際の動作
tsc -p tsconfig.json
```

**出力:**
```
src/cli.ts           → bin/cli.js
src/config.ts        → bin/config.js
src/types.ts         → bin/types.js
...
```

**追加ファイル:**
- `.d.ts` - TypeScript 型定義
- `.js.map` - ソースマップ（デバッグ用）

### package.json の bin フィールド

```json
{
  "bin": {
    "airc": "bin/cli.js"
  }
}
```

これにより、`npx @maru3460/airc` で `bin/cli.js` が実行されます。

## 次のステップ

仕組みを理解できたら、実際に開発に参加してみましょう！

→ [06_開発に参加する.md](06_開発に参加する.md) へ進む
