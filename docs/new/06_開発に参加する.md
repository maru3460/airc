# 開発に参加する

airc の開発に参加する方法を、ステップバイステップで説明します。

## 開発に必要なもの

### 必須

- **Node.js 18.0.0 以上** - [02_環境構築.md](02_環境構築.md) を参照
- **Git** - バージョン管理ツール
- **GitHub アカウント** - コントリビューションに必要
- **エディタ** - VS Code などのコードエディタ

### 推奨

- **TypeScript の基礎知識** - 型システムの理解
- **Node.js の基礎知識** - fs, https モジュールなど
- **Git の基礎知識** - clone, branch, commit, push など

## 開発環境のセットアップ

### ステップ1: リポジトリをフォークする

1. [airc リポジトリ](https://github.com/maru3460/airc) にアクセス
2. 右上の「Fork」ボタンをクリック
3. 自分のアカウントにフォークを作成

### ステップ2: ローカルにクローンする

```bash
# フォークしたリポジトリをクローン
git clone https://github.com/<your-username>/airc.git
cd airc

# 本家リポジトリを upstream として追加
git remote add upstream https://github.com/maru3460/airc.git

# リモートリポジトリを確認
git remote -v
# origin    https://github.com/<your-username>/airc.git (fetch)
# origin    https://github.com/<your-username>/airc.git (push)
# upstream  https://github.com/maru3460/airc.git (fetch)
# upstream  https://github.com/maru3460/airc.git (push)
```

### ステップ3: 依存関係をインストールする

```bash
# npm パッケージをインストール
npm install
```

**インストールされるもの:**
- TypeScript コンパイラ
- yargs（CLI パーサー）
- 型定義ファイル
- Git Hook（pre-commit）

### ステップ4: ビルドする

```bash
# TypeScript → JavaScript にビルド
npm run build
```

**出力先:** `bin/` ディレクトリ

### ステップ5: ローカルで動作確認

```bash
# ビルドした CLI を実行
node bin/cli.js --help

# デフォルトプロジェクトをダウンロード（テスト）
node bin/cli.js
```

## 開発ワークフロー

### 1. 機能ブランチを作成する

```bash
# 本家の最新版を取得
git fetch upstream
git merge upstream/main

# 機能ブランチを作成
git checkout -b feature/add-new-feature
```

### 2. コードを編集する

開発モードでファイル変更を監視しながら開発できます：

```bash
# TypeScript ファイルを監視してビルド
npm run dev
```

**開発モードの動作:**
- `src/` 配下のファイルを監視
- 変更があれば自動的にビルド
- `bin/` に出力

### 3. テストする

```bash
# ビルドした CLI を実行してテスト
node bin/cli.js -p default

# 別のプロジェクトでもテスト
node bin/cli.js -p projectA

# 強制上書きオプションのテスト
node bin/cli.js --force
```

### 4. コミットする

```bash
# 変更をステージング
git add src/

# コミット（pre-commit hook で files.json が自動生成される）
git commit -m "Add new feature: ..."
```

**コミットメッセージの例:**
- `Add feature: support custom GitHub token`
- `Fix bug: handle network timeout properly`
- `Update docs: improve installation guide`
- `Refactor: extract download logic to separate module`

### 5. プッシュする

```bash
# フォークリポジトリにプッシュ
git push origin feature/add-new-feature
```

### 6. Pull Request を作成する

1. GitHub でフォークリポジトリにアクセス
2. 「Compare & pull request」ボタンをクリック
3. 変更内容を説明
4. 「Create pull request」をクリック

**Pull Request のテンプレート:**

```markdown
## 概要
この PR は、[機能名] を追加します。

## 変更内容
- ✨ 新機能: [説明]
- 🐛 バグ修正: [説明]
- 📝 ドキュメント: [説明]

## テスト方法
1. `npm install` を実行
2. `npm run build` を実行
3. `node bin/cli.js [オプション]` を実行

## チェックリスト
- [ ] コードが正しく動作することを確認
- [ ] TypeScript のコンパイルエラーがないことを確認
- [ ] ドキュメントを更新（必要な場合）
```

## コードの構造

### モジュール分割

airc は機能ごとにモジュールが分割されています：

```
src/
├── cli.ts              # エントリポイント
├── config.ts           # 設定定数
├── types.ts            # 型定義
├── cli/                # CLI 関連
│   ├── yargs.ts        # 引数解析
│   └── commands.ts     # コマンド実行
├── github/             # GitHub 連携
│   ├── api.ts          # API 操作
│   └── download.ts     # ファイルダウンロード
└── utils/              # ユーティリティ
    ├── path.ts         # パス操作
    └── fs.ts           # ファイル操作
```

### 新しい機能を追加する場合

**例: GitHub 認証機能を追加する**

1. **型定義を追加** (`src/types.ts`)
   ```typescript
   export interface GitHubAuth {
     token: string;
   }
   ```

2. **設定を追加** (`src/config.ts`)
   ```typescript
   export const GITHUB_TOKEN_ENV = "AIRC_GITHUB_TOKEN";
   ```

3. **機能を実装** (`src/github/auth.ts` - 新規ファイル)
   ```typescript
   import { GITHUB_TOKEN_ENV } from '../config.js';

   export function getGitHubToken(): string | null {
     return process.env[GITHUB_TOKEN_ENV] || null;
   }
   ```

4. **既存コードに統合** (`src/github/api.ts`)
   ```typescript
   import { getGitHubToken } from './auth.js';

   export async function fetchManifest(project: string): Promise<Manifest | null> {
     const token = getGitHubToken();
     const headers = token ? { Authorization: `Bearer ${token}` } : {};

     // ...
   }
   ```

5. **ビルドしてテスト**
   ```bash
   npm run build
   node bin/cli.js
   ```

## コーディング規約

### TypeScript

- **厳密な型チェック**: `strict: true` を使用
- **型注釈**: 関数の引数と戻り値に型を明記
- **インターフェース**: 複雑なオブジェクトは interface で定義

**良い例:**
```typescript
export async function downloadFile(
  filePath: string,
  options: CliOptions
): Promise<DownloadResult> {
  // ...
}
```

**悪い例:**
```typescript
export async function downloadFile(filePath, options) {
  // 型がない
}
```

### ファイル構成

- **相対パス**: モジュールインポートは相対パス + `.js` 拡張子
  ```typescript
  import { REPO_OWNER } from '../config.js';
  ```

- **ESM 形式**: `import` / `export` を使用（`require` は使わない）

### コメント

- **関数の説明**: 複雑な関数には JSDoc コメントを追加
  ```typescript
  /**
   * GitHub からマニフェストファイルを取得します
   * @param project - プロジェクト名
   * @returns マニフェストオブジェクト、または null
   */
  export async function fetchManifest(project: string): Promise<Manifest | null> {
    // ...
  }
  ```

### エラーハンドリング

- **非致命的エラー**: try-catch でキャッチして継続
  ```typescript
  try {
    await downloadFile(file, options);
  } catch (error) {
    console.error(`❌ エラー: ${error.message}`);
    stats.error++;
    // 処理を継続
  }
  ```

- **致命的エラー**: エラーメッセージを表示して終了
  ```typescript
  if (!manifest && !files) {
    console.error('❌ エラー: プロジェクトが見つかりません');
    process.exit(1);
  }
  ```

## デバッグ

### console.log でデバッグ

```typescript
console.log('DEBUG: filePath =', filePath);
console.log('DEBUG: localPath =', localPath);
```

### SourceMap を使う

TypeScript のソースマップを使うと、元の TypeScript ファイルの行番号でデバッグできます。

```bash
# ソースマップ付きでビルド（デフォルトで有効）
npm run build

# Node.js でソースマップを有効化して実行
node --enable-source-maps bin/cli.js
```

### VS Code でデバッグ

`.vscode/launch.json` を作成：

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "type": "node",
      "request": "launch",
      "name": "Debug airc",
      "program": "${workspaceFolder}/bin/cli.js",
      "args": ["-p", "default"],
      "sourceMaps": true,
      "outFiles": ["${workspaceFolder}/bin/**/*.js"]
    }
  ]
}
```

## よくある開発タスク

### 新しいコマンドオプションを追加

1. `src/types.ts` に型を追加
   ```typescript
   export interface CliOptions {
     project: string;
     force: boolean;
     verbose: boolean;  // 追加
   }
   ```

2. `src/cli/yargs.ts` にオプションを追加
   ```typescript
   .option('verbose', {
     alias: 'v',
     type: 'boolean',
     default: false,
     description: '詳細なログを表示'
   })
   ```

3. 機能を実装
   ```typescript
   if (options.verbose) {
     console.log('詳細ログ: ダウンロード中...');
   }
   ```

### 新しいプロジェクトを追加（開発用）

```bash
# プロジェクトディレクトリを作成
mkdir -p profiles/test-project/.github/prompts

# サンプルファイルを作成
echo "# Test Prompt" > profiles/test-project/.github/prompts/test.md

# マニフェストを生成
node scripts/generate-manifest.js

# テスト
node bin/cli.js -p test-project
```

### マニフェスト生成スクリプトを改善

`scripts/generate-manifest.js` を編集して、新しい機能を追加できます。

例: ファイルサイズの制限を追加

```javascript
const stats = fs.statSync(filePath);
if (stats.size > MAX_FILE_SIZE) {
  console.warn(`警告: ${filePath} がサイズ制限を超えています`);
  continue;
}
```

## コントリビューションのヒント

### 小さな変更から始める

最初は以下のような小さな変更から始めるのがおすすめです：

- ドキュメントの誤字修正
- エラーメッセージの改善
- コードコメントの追加
- 軽微なバグ修正

### Issue を確認する

[GitHub Issues](https://github.com/maru3460/airc/issues) を確認して、未解決の問題や機能リクエストを探しましょう。

### 質問する

不明な点があれば、遠慮なく Issue や Discussion で質問してください！

## トラブルシューティング

### ビルドエラー: `Cannot find module`

```bash
# node_modules を削除して再インストール
rm -rf node_modules
npm install
npm run build
```

### Git Hook が動作しない

```bash
# Git Hook を再設定
npm install
```

### TypeScript のエラーが出る

```bash
# TypeScript のバージョンを確認
npx tsc --version

# ビルドして詳細なエラーを確認
npm run build
```

## 次のステップ

開発環境が整ったら、実際にコードを書いてみましょう！

- **小さな変更を試す**: ドキュメントの誤字修正など
- **Issue を確認する**: 未解決の問題を探す
- **Pull Request を作成する**: 変更を本家リポジトリに提案

## 参考資料

- [TypeScript 公式ドキュメント](https://www.typescriptlang.org/docs/)
- [Node.js 公式ドキュメント](https://nodejs.org/docs/)
- [GitHub Flow](https://docs.github.com/en/get-started/quickstart/github-flow) - GitHub でのコラボレーションの基本

---

ご質問や不明な点があれば、GitHub の Issue や Discussion でお気軽にお聞きください！
