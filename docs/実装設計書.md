# 実装設計書：airc

## 1. モジュール設計

### 1.1 ファイル構成

```
bin/
└── cli.js          # メインエントリポイント（単一ファイル）
    ├── 設定定義
    ├── ユーティリティ関数
    ├── メイン処理
    └── エラーハンドリング
```

### 1.2 モジュール構造

シングルファイル構成で、以下のセクションで構成されます：

1. **Shebang & インポート**
2. **定数定義** (リポジトリ情報)
3. **ユーティリティ関数** (`fileExists`, `askOverwrite`)
4. **GitHub API 関数** (`getProjectFiles` - 再帰的にファイルリストを取得)
5. **コア関数** (`downloadFile`, `showHelp`)
6. **メイン関数** (`main`)
7. **実行**

## 2. データ構造設計

### 2.1 定数定義

```javascript
// リポジトリ情報
const REPO_OWNER = "maru3460";
const REPO_NAME = "airc";
const REPO_BRANCH = "main";

// GitHub API ベース URL
const GITHUB_API_BASE = "https://api.github.com";
const GITHUB_RAW_BASE = "https://raw.githubusercontent.com";
```

### 2.2 コマンドライン引数構造

```javascript
{
  profile: string,  // プロファイル名 (default: "default")
  force: boolean    // 強制上書きフラグ (default: false)
}
```

**簡略化のポイント**:
- `type` と `file` オプションを削除（プロファイル配下を全ダウンロード）
- プロファイル指定なしの場合は `"default"` を使用

## 3. 関数設計

### 3.1 ユーティリティ関数

#### fileExists(path: string): Promise<boolean>

**目的**: ファイルの存在確認

**シグネチャ**:

```javascript
async function fileExists(path) {
  // ...
}
```

**引数**:
- `path` (string): 確認するファイルパス

**戻り値**:
- `Promise<boolean>`: ファイルが存在する場合 `true`、存在しない場合 `false`

**実装**:
- `fs/promises` の `access()` を使用
- アクセスエラーを `false` として扱う

#### askOverwrite(filename: string): Promise<boolean>

**目的**: ユーザーに上書き確認プロンプトを表示

**シグネチャ**:

```javascript
async function askOverwrite(filename) {
  // ...
}
```

**引数**:
- `filename` (string): 上書き対象のファイル名

**戻り値**:
- `Promise<boolean>`: 上書きする場合 `true`、スキップする場合 `false`

**実装**:
- `readline` の `createInterface()` を使用
- 入力: `y` / `N`（デフォルト `N`）
- プロンプト: `File {filename} already exists. Overwrite? (y/N): `

### 3.2 GitHub API 関数

#### getProfileFiles(owner, repo, profile)

**目的**: GitHub API を使用してプロファイル配下のファイルリストを再帰的に取得

**シグネチャ**:

```javascript
async function getProfileFiles(owner, repo, profile) {
  // ...
}
```

**引数**:
- `owner` (string): リポジトリオーナー名
- `repo` (string): リポジトリ名
- `profile` (string): プロファイル名

**戻り値**:
- `Promise<string[]>`: ファイルパスのリスト
  ```javascript
  [
    "profiles/default/.github/chatmodes/file1.md",
    "profiles/default/.claude/instructions.md",
    "profiles/default/CLAUDE.md"
  ]
  ```

**処理フロー**:
1. GitHub API エンドポイントを構築
   ```
   https://api.github.com/repos/{owner}/{repo}/contents/profiles/{profile}
   ```
2. API リクエストを実行
3. レスポンスを解析
   - `type: "file"` → ファイルパスをリストに追加
   - `type: "dir"` → 再帰的にサブディレクトリを取得
4. すべてのファイルパスを返す

**エラー処理**:
- 404 エラー: プロファイルが存在しない
- 403 エラー: レート制限超過
- その他の HTTP エラー: ネットワークエラー

### 3.3 コア関数

#### downloadFile(filePath, profile, force)

**目的**: 単一ファイルのダウンロードと保存

**シグネチャ**:

```javascript
async function downloadFile(filePath, profile, force) {
  // ...
}
```

**引数**:
- `filePath` (string): GitHub 上のファイルパス（例: `profiles/default/.github/chatmodes/file.md`）
- `profile` (string): プロファイル名（パス変換用）
- `force` (boolean): 強制上書きフラグ

**処理フロー**:

1. **URL 生成**
   ```javascript
   const url = `${GITHUB_RAW_BASE}/${REPO_OWNER}/${REPO_NAME}/${REPO_BRANCH}/${filePath}`;
   // 例: https://raw.githubusercontent.com/maru3460/airc/main/profiles/default/.github/chatmodes/file.md
   ```

2. **ローカルパス生成**
   ```javascript
   // profiles/{profile}/ を除去
   const localPath = filePath.replace(`profiles/${profile}/`, "");
   // 例: profiles/default/.github/chatmodes/file.md → .github/chatmodes/file.md
   ```

3. **存在チェック**
   - ファイルが存在し、`force=false` の場合 → 上書き確認

4. **ディレクトリ作成**
   - 必要に応じて親ディレクトリを作成

5. **HTTP リクエスト**
   - `https.get()` でファイルをダウンロード

6. **ファイル書き込み**
   - ダウンロードしたデータをファイルに書き込み

**エラー処理**:
- HTTP エラー（404 等）: エラーメッセージ表示して継続
- 書き込みエラー: エラーメッセージ表示して継続

**出力メッセージ**:
- 成功: `✓ Downloaded: {localPath}`
- スキップ: `⊘ Skipped: {localPath}`
- エラー: `✗ Failed to download {localPath}: {reason}`

#### showHelp()

**目的**: ヘルプメッセージを表示

**シグネチャ**:

```javascript
function showHelp() {
  // ...
}
```

**出力内容**:
- 使用方法
- オプション一覧と説明
- 使用例

#### main()

**目的**: CLI のメインエントリポイント

**シグネチャ**:

```javascript
async function main() {
  // ...
}
```

**処理フロー**:

1. **引数解析**
   - `process.argv` から引数を抽出
   - オプションをパース
   - プロファイル指定なし → `profile = "default"`

2. **特殊コマンド判定**
   - `--help` → ヘルプ表示して終了

3. **GitHub API でファイルリスト取得**
   ```javascript
   const files = await getProfileFiles(REPO_OWNER, REPO_NAME, profile);
   ```
   - プロファイルが存在しない場合はエラー（404）

4. **ダウンロード実行**
   - 各ファイルに対して `downloadFile()` を呼び出し
   ```javascript
   for (const filePath of files) {
     await downloadFile(filePath, profile, force);
   }
   ```

5. **結果表示**
   - 完了メッセージ: `✨ Done!`

**エラー処理**:
- 最上位の `try-catch` ですべてのエラーをキャッチ
- GitHub API エラー（404, 403 等）: エラーメッセージ表示して終了
- 致命的エラー時は `process.exit(1)`

## 4. 引数解析設計

### 4.1 コマンドライン引数

| オプション   | 短縮形 | 説明                   | デフォルト |
| ------------ | ------ | ---------------------- | ---------- |
| `--profile`  | なし   | プロファイル名を指定   | `default`  |
| `--force`    | `-f`   | 確認なしで上書き       | `false`    |
| `--help`     | `-h`   | ヘルプメッセージ表示   | -          |

**簡略化されたオプション**:
- `--type` と `--file` は削除（プロファイル配下を全ダウンロード）
- `--list-profiles` は削除（GitHub API で動的に取得するため）

### 4.2 引数パースロジック

```javascript
const args = process.argv.slice(2);
let profile = "default";
let force = false;

for (let i = 0; i < args.length; i++) {
  switch (args[i]) {
    case "--profile":
      profile = args[++i];
      break;
    case "-f":
    case "--force":
      force = true;
      break;
    case "-h":
    case "--help":
      showHelp();
      return;
  }
}
```

## 5. エラー処理設計

### 5.1 エラーメッセージ定義

```javascript
const ERROR_MESSAGES = {
  PROFILE_NOT_FOUND: (name) =>
    `❌ Profile not found: ${name}\n\nPlease check if the profile exists in the repository.`,

  RATE_LIMIT_EXCEEDED: (resetTime) =>
    `❌ GitHub API rate limit exceeded.\nPlease try again after ${resetTime}.`,

  API_ERROR: (status, message) =>
    `❌ GitHub API error (${status}): ${message}`,

  DOWNLOAD_FAILED: (file, reason) =>
    `✗ Failed to download ${file}: ${reason}`,

  WRITE_FAILED: (file, reason) =>
    `✗ Failed to write ${file}: ${reason}`,
};
```

### 5.2 エラーハンドリング戦略

**致命的エラー**（処理を中断）:
- プロファイルが存在しない（404）
- GitHub API レート制限超過（403）
- GitHub API エラー（その他）

**非致命的エラー**（エラーメッセージ表示して継続）:
- 個別ファイルのダウンロード失敗
- ファイル書き込みエラー

## 6. 出力設計

### 6.1 進捗表示

```
🚀 Downloading configurations for project: default

✓ Downloaded: .github/chatmodes/best-practices.md
✓ Downloaded: .github/prompts/refactor.md
⊘ Skipped: .claude/instructions/basic.md (already exists)
✓ Downloaded: CLAUDE.md

✨ Done! (3 files downloaded, 1 skipped)
```

**シンプル化のポイント**:
- タイプ別の区切りは削除（ファイル単位で表示）
- ダウンロード結果のサマリーを表示

### 6.2 アイコン使用

| アイコン | 用途           |
| -------- | -------------- |
| 🚀       | 処理開始       |
| ✓        | 成功           |
| ⊘        | スキップ       |
| ✗        | エラー         |
| ✨       | 完了           |
| ❌       | 致命的エラー   |

## 7. package.json 設計

### 7.1 必須フィールド

```json
{
  "name": "@maru3460/airc",
  "version": "1.0.0",
  "description": "Download and sync AI tool configurations (GitHub Copilot, Claude)",
  "type": "module",
  "bin": {
    "airc": "./bin/cli.js"
  },
  "engines": {
    "node": ">=18.0.0"
  },
  "files": ["bin/"],
  "keywords": ["github-copilot", "claude", "chatmodes", "prompts", "cli", "airc"]
}
```

### 7.2 オプションフィールド

```json
{
  "repository": {
    "type": "git",
    "url": "https://github.com/maru3460/airc"
  },
  "author": "maru3460",
  "license": "MIT"
}
```

## 8. GitHub API レート制限対策

### 8.1 レート制限の仕様

- **未認証**: 60 リクエスト/時間
- **認証済み**: 5000 リクエスト/時間（将来対応）

### 8.2 現在の対策

- プロファイル配下のディレクトリ構造を再帰的に取得するため、複数の API リクエストが必要
- 通常のプロファイル（3〜5 ディレクトリ）であれば、5〜10 リクエスト程度
- 60 リクエスト/時間で十分対応可能

### 8.3 レート制限超過時の対応

```javascript
if (response.status === 403) {
  const resetTime = response.headers.get('x-ratelimit-reset');
  const resetDate = new Date(resetTime * 1000);
  console.error(`❌ GitHub API rate limit exceeded.\nPlease try again after ${resetDate.toLocaleString()}.`);
  process.exit(1);
}
```

### 8.4 将来的な対応（マニフェスト方式への移行）

レート制限が問題になった場合、`files.json` マニフェスト方式に移行：

```json
// profiles/{profile}/files.json
{
  "files": [
    ".github/chatmodes/file1.md",
    ".github/prompts/file2.md",
    ".claude/instructions.md",
    "CLAUDE.md"
  ]
}
```

この場合、API リクエストは 1 回のみ（`files.json` の取得のみ）
