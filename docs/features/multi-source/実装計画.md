# マルチソース対応機能 - 実装計画

## 実装フェーズ

マルチソース対応機能を段階的に実装していきます。各フェーズは独立して動作可能な状態を保ちます。

### Phase 1: 設定ファイル管理基盤 🏗️

**目的**: 設定ファイルの読み書き機能を実装し、マルチソース対応の基盤を作る

**実装内容**:

1. **設定ファイル管理** (`src/config.ts`)
   - 設定ファイルの読み込み・保存
   - デフォルト設定の生成
   - バリデーション

2. **型定義の拡張** (`src/types.ts`)
   - `Config` インターフェース
   - `SourceConfig` 型
   - `FileInfo` インターフェース

3. **初回マイグレーション**
   - 既存ユーザー向けに `default` ソースを自動生成
   - 設定ファイル作成の通知

**成果物**:
- `~/.config/airc/config.json` の自動生成
- 設定ファイルの CRUD 操作

**テスト項目**:
- [ ] 設定ファイルが存在しない場合のデフォルト生成
- [ ] 設定ファイルの読み込み
- [ ] 設定ファイルの保存
- [ ] 不正な設定ファイルのバリデーション

**完了条件**:
- ✅ 設定ファイルの読み書きが動作する
- ✅ 既存の `airc` コマンドが引き続き動作する

---

### Phase 2: コマンド基盤の整備 🔧

**目的**: ソース管理コマンドを実装する

**実装内容**:

1. **コマンドディレクトリの作成** (`src/commands/`)
   - `add.ts`: ソース追加コマンド
   - `list.ts`: ソース一覧表示
   - `remove.ts`: ソース削除
   - `set-default.ts`: デフォルトソース設定

2. **CLI の拡張** (`src/cli.ts`)
   - 新しいコマンドのルーティング
   - ヘルプメッセージの更新

3. **ソース追加機能**
   - GitHub リポジトリの登録（認証なし）
   - ソース名の重複チェック
   - 設定ファイルへの保存

**成果物**:
- `airc add <name> github:owner/repo -p project`
- `airc list`
- `airc remove <name>`
- `airc set-default <name>`

**テスト項目**:
- [ ] ソースの追加
- [ ] 同名ソースの上書き確認
- [ ] ソースの削除
- [ ] デフォルトソースの設定
- [ ] ソース一覧の表示

**完了条件**:
- ✅ ソース管理コマンドが動作する
- ✅ 設定ファイルが正しく更新される

---

### Phase 3: ソース抽象化とローカルソース対応 📂

**目的**: ソースの抽象化を行い、ローカルファイルシステムからのインポートに対応する

**実装内容**:

1. **ソース基盤** (`src/sources/base.ts`)
   - `Source` インターフェース
   - `SourceFactory` クラス

2. **GitHub Public ソース** (`src/sources/github.ts`)
   - 既存のコードを移動・リファクタリング
   - `Source` インターフェースの実装

3. **ローカルソース** (`src/sources/local.ts`)
   - ローカルディレクトリからのファイル検索
   - ファイルコピー機能
   - パス検証

4. **sync コマンドの実装** (`src/commands/sync.ts`)
   - ソース指定での同期
   - デフォルトソースの同期
   - 全ソース同期（`--all`）

**成果物**:
- `airc add local-dev local:/path/to/repo`
- `airc sync [name]`
- `airc sync --all`

**テスト項目**:
- [ ] ローカルソースの追加
- [ ] ローカルソースからのファイルリスト取得
- [ ] ローカルソースからのファイルコピー
- [ ] パストラバーサル攻撃の防止
- [ ] 複数ソースの同期

**完了条件**:
- ✅ ローカルリポジトリからのインポートが動作する
- ✅ GitHub と ローカルの両方のソースを管理できる

---

### Phase 4: GitHub 認証対応（Private リポジトリ） 🔐

**目的**: GitHub Token を使った認証機能を追加し、Organization の private リポジトリに対応する

**実装内容**:

1. **GitHub 認証ソース** (`src/sources/github-auth.ts`)
   - GitHub Token を使った認証
   - Octokit による API 呼び出し
   - Private リポジトリへのアクセス

2. **認証情報の管理**
   - 環境変数からの Token 読み込み
   - 対話的な Token 入力
   - （将来）設定ファイルでの暗号化保存

3. **add コマンドの拡張**
   - `--token` オプション
   - `--token-env` オプション
   - 対話的な Token 入力モード

**成果物**:
- `airc add company github:org/repo --profile my-profile --token-env GITHUB_TOKEN`
- `airc add company github:org/repo --profile my-profile --token ghp_xxxxx`
- `airc add company github:org/repo --profile my-profile` (対話的入力)

**テスト項目**:
- [ ] 環境変数からの Token 読み込み
- [ ] Token を使った GitHub API 呼び出し
- [ ] Private リポジトリへのアクセス
- [ ] Token が無効な場合のエラーハンドリング
- [ ] レート制限のハンドリング

**完了条件**:
- ✅ Private リポジトリからのダウンロードが動作する
- ✅ Token の管理が安全に行われる

---

### Phase 5: UX 改善と最適化 ✨

**目的**: ユーザーエクスペリエンスを向上させる

**実装内容**:

1. **進捗表示**
   - ダウンロード中のプログレスバー
   - ファイル数とサイズの表示

2. **エラーメッセージの改善**
   - より分かりやすいエラーメッセージ
   - トラブルシューティングのヒント

3. **パフォーマンス最適化**
   - 並列ダウンロード
   - ファイルリストのキャッシュ
   - 変更検出（ハッシュ比較）

4. **インタラクティブな初期設定**
   - `airc init` コマンド
   - 対話的なソース登録ウィザード

**成果物**:
- プログレスバー表示
- `airc init` コマンド
- パフォーマンス改善

**テスト項目**:
- [ ] プログレスバーの表示
- [ ] 並列ダウンロードの動作
- [ ] キャッシュの有効性
- [ ] init コマンドの動作

**完了条件**:
- ✅ UX が大幅に改善される
- ✅ パフォーマンスが向上する

---

## 後方互換性の保ち方

### 既存コマンドのサポート

Phase 1 から Phase 5 まで、以下の既存コマンドは引き続き動作します：

```bash
# Phase 1-5 を通じてサポート
airc                  # → デフォルトソースを同期
airc -p my-profile       # → maru3460/airc/{profile} を一時的に同期
airc --force          # → デフォルトソースを強制同期
airc --help           # → ヘルプ表示
```

### 実装方法

```typescript
// src/cli.ts
async function main() {
  const args = parseArgs();

  // 新しいコマンド形式（Phase 2 以降）
  if (args.command) {
    switch (args.command) {
      case 'add':
        return await addCommand(args);
      case 'sync':
        return await syncCommand(args);
      case 'list':
        return await listCommand();
      // ... 他のコマンド
    }
  }

  // 既存の使い方（Phase 1 から継続サポート）
  // `airc` または `airc -p project` の形式
  const configManager = new ConfigManager();
  const config = await configManager.load();

  // --profile オプションがある場合は一時的なソースを使用
  if (args.profile) {
    const tempSource: GitHubSourceConfig = {
      type: 'github',
      repo: 'maru3460/airc',
      profile: args.profile,
      branch: 'main',
    };
    return await syncWithSource(tempSource, args.force);
  }

  // デフォルトソースを使用
  const sourceConfig = config.sources[config.defaultSource];
  return await syncWithSource(sourceConfig, args.force);
}
```

## マイグレーション戦略

### v1.x → v2.0

**マイグレーション内容**:

1. 初回起動時に `~/.config/airc/config.json` を自動生成
2. `default` ソースを自動登録（`maru3460/airc/default`）
3. ユーザーに通知メッセージを表示

**実装**:

```typescript
async function ensureConfig(): Promise<void> {
  const configManager = new ConfigManager();

  try {
    await configManager.load();
    // 設定ファイルが存在する場合は何もしない
  } catch {
    // 設定ファイルが存在しない場合
    console.log('✨ airc v2.0 へようこそ！');
    console.log('📝 設定ファイルを作成しています...');

    const defaultConfig: Config = {
      version: '2.0.0',
      sources: {
        default: {
          type: 'github',
          repo: 'maru3460/airc',
          profile: 'default',
          branch: 'main',
        },
      },
      defaultSource: 'default',
    };

    await configManager.save(defaultConfig);

    console.log('✅ 設定ファイルを作成しました');
    console.log(`   場所: ${configManager.configPath}`);
    console.log('');
    console.log('💡 新機能を試してみましょう:');
    console.log('   - airc list          # ソース一覧を表示');
    console.log('   - airc add <name>    # 新しいソースを追加');
    console.log('   - airc sync [name]   # ソースから同期');
    console.log('');
  }
}
```

## 依存関係の追加

### Phase 1-2

```json
{
  "dependencies": {
    "yargs": "^17.7.2"
  }
}
```

### Phase 3

```json
{
  "dependencies": {
    "yargs": "^17.7.2",
    "glob": "^10.3.10"
  }
}
```

### Phase 4

```json
{
  "dependencies": {
    "yargs": "^17.7.2",
    "glob": "^10.3.10",
    "@octokit/rest": "^20.0.2"
  }
}
```

### Phase 5

```json
{
  "dependencies": {
    "yargs": "^17.7.2",
    "glob": "^10.3.10",
    "@octokit/rest": "^20.0.2",
    "cli-progress": "^3.12.0",
    "chalk": "^5.3.0"
  }
}
```

## テスト計画

### ユニットテスト

各フェーズで以下のテストを追加：

**Phase 1**:
- `ConfigManager` のテスト
  - `load()`: 設定ファイルの読み込み
  - `save()`: 設定ファイルの保存
  - `createDefaultConfig()`: デフォルト設定生成

**Phase 2**:
- `addCommand()`: ソース追加
- `removeCommand()`: ソース削除
- `setDefaultCommand()`: デフォルトソース設定
- `listCommand()`: ソース一覧表示

**Phase 3**:
- `SourceFactory.createSource()`: ソース生成
- `GitHubPublicSource`: GitHub Public リポジトリ
- `LocalSource`: ローカルファイルシステム
- `syncCommand()`: 同期コマンド

**Phase 4**:
- `GitHubAuthSource`: GitHub 認証
- Token の取得方法（環境変数、直接指定）

**Phase 5**:
- パフォーマンス測定
- キャッシュの動作確認

### 統合テスト

**テストシナリオ**:

1. **基本ワークフロー**
   ```bash
   # ソース追加
   airc add test-source github:test/repo -p test

   # 同期
   airc sync test-source

   # ファイルが正しくダウンロードされているか確認
   ls -la .github/chatmodes/
   ls -la .claude/
   ```

2. **複数ソースの管理**
   ```bash
   # 複数ソースを追加
   airc add source1 github:test/repo1 -p test1
   airc add source2 github:test/repo2 -p test2

   # デフォルトソースの切り替え
   airc set-default source1
   airc sync

   airc set-default source2
   airc sync
   ```

3. **ローカルソースのテスト**
   ```bash
   # テスト用ローカルリポジトリを作成
   mkdir -p /tmp/airc-test-repo/.github/chatmodes
   echo "test" > /tmp/airc-test-repo/.github/chatmodes/test.md

   # ローカルソースを追加
   airc add local-test local:/tmp/airc-test-repo

   # 同期
   airc sync local-test

   # ファイル確認
   cat .github/chatmodes/test.md
   ```

4. **エラーハンドリング**
   ```bash
   # 存在しないソース
   airc sync non-existent  # → エラー

   # 無効なリポジトリ
   airc add bad github:invalid/repo -p test  # → エラー

   # 無効なローカルパス
   airc add bad local:/non/existent/path  # → エラー
   ```

### テストデータの準備

**GitHub テストリポジトリ**:
- Public リポジトリ: `maru3460/airc-test-public`
- Private リポジトリ: `maru3460/airc-test-private` (Phase 4)

**ディレクトリ構造**:
```
airc-test-public/
└── profiles/
    └── test/
        ├── .github/
        │   ├── chatmodes/
        │   │   └── test-mode.md
        │   └── prompts/
        │       └── test-prompt.md
        ├── .claude/
        │   └── test-instruction.md
        └── CLAUDE.md
```

## リリース計画

### Phase 1-2: v2.0.0-beta.1

**リリース内容**:
- 設定ファイル管理機能
- ソース管理コマンド（add, list, remove, set-default）
- 後方互換性の維持

**リリースノート**:
```markdown
## v2.0.0-beta.1

### 新機能
- 🎉 マルチソース対応機能（ベータ版）
- 📝 設定ファイル管理（~/.config/airc/config.json）
- ➕ ソース追加コマンド（airc add）
- 📋 ソース一覧表示（airc list）
- 🗑️ ソース削除（airc remove）
- ⭐ デフォルトソース設定（airc set-default）

### 改善
- 既存の使い方もサポート（後方互換性あり）
```

### Phase 3: v2.0.0-beta.2

**リリース内容**:
- ローカルソース対応
- sync コマンド

**リリースノート**:
```markdown
## v2.0.0-beta.2

### 新機能
- 📂 ローカルリポジトリ対応
- 🔄 sync コマンド
- 🚀 複数ソース一括同期（--all）

### 改善
- ソースの抽象化
```

### Phase 4: v2.0.0-rc.1

**リリース内容**:
- GitHub 認証機能
- Private リポジトリ対応

**リリースノート**:
```markdown
## v2.0.0-rc.1

### 新機能
- 🔐 GitHub Token 認証対応
- 🏢 Organization の private リポジトリ対応
- 🔑 環境変数からの Token 読み込み

### 改善
- セキュリティの強化
```

### Phase 5: v2.0.0

**リリース内容**:
- UX 改善
- パフォーマンス最適化
- 正式リリース

**リリースノート**:
```markdown
## v2.0.0

### 新機能
- ✨ UX の大幅改善
- 📊 プログレスバー表示
- 🚄 並列ダウンロード対応
- 💾 ファイルリストのキャッシュ
- 🎯 airc init コマンド

### 改善
- パフォーマンスの大幅向上
- エラーメッセージの改善

### 破壊的変更
- なし（完全な後方互換性あり）
```

## 開発時の注意事項

### コーディング規約

1. **TypeScript の厳格モード**
   ```json
   {
     "compilerOptions": {
       "strict": true,
       "noImplicitAny": true,
       "strictNullChecks": true
     }
   }
   ```

2. **エラーハンドリング**
   - すべての非同期処理で適切なエラーハンドリング
   - ユーザーフレンドリーなエラーメッセージ

3. **セキュリティ**
   - パス検証を徹底
   - 認証情報の平文保存を避ける
   - 入力値のサニタイズ

### コミットメッセージ

```
<type>(<phase>): <subject>

<body>

<footer>
```

**例**:
```
feat(phase-1): Add ConfigManager class

- Implement config file load/save
- Add default config generation
- Add migration from v1.x

Closes #123
```

**Type**:
- `feat`: 新機能
- `fix`: バグ修正
- `docs`: ドキュメント
- `refactor`: リファクタリング
- `test`: テスト追加

### ブランチ戦略

```
main
  ├── feature/phase-1-config-management
  ├── feature/phase-2-command-foundation
  ├── feature/phase-3-local-source
  ├── feature/phase-4-github-auth
  └── feature/phase-5-ux-improvements
```

各フェーズを別ブランチで開発し、完了後に `main` にマージします。

## 次のステップ

1. **Phase 1 の開始**: 設定ファイル管理基盤の実装
2. **テスト環境の準備**: GitHub テストリポジトリの作成
3. **ドキュメントの更新**: README.md の更新

質問や不明点があれば、いつでもお知らせください！ 🍛✨
