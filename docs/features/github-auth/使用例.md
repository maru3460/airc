# GitHub トークン認証機能 - 使用例

## 基本的な使い方

### 1. GitHub Token の取得

#### Token の生成手順

1. GitHub にログイン
2. [Settings > Developer settings > Personal access tokens > Tokens (classic)](https://github.com/settings/tokens) に移動
3. **"Generate new token (classic)"** をクリック
4. Token の設定:
   - **Note**: `airc CLI` など、用途がわかる名前を入力
   - **Expiration**: 有効期限を選択（推奨: 90 days または No expiration）
   - **Select scopes**:
     - Public リポジトリのみの場合: **スコープは選択不要**（空でOK）
     - Private リポジトリも使う場合（将来）: `repo` をチェック
5. **"Generate token"** をクリック
6. 生成された Token をコピー（後で確認できないので注意！）

生成される Token の形式:
```
ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

### 2. 環境変数への設定

#### Linux / macOS (bash/zsh)

```bash
# ~/.bashrc または ~/.zshrc に追加
export GITHUB_TOKEN="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"

# 設定を反映
source ~/.bashrc  # または source ~/.zshrc
```

#### Windows (PowerShell)

```powershell
# ユーザー環境変数に設定
[System.Environment]::SetEnvironmentVariable(
  'GITHUB_TOKEN',
  'ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx',
  'User'
)

# 設定確認
echo $env:GITHUB_TOKEN
```

#### Windows (コマンドプロンプト)

```cmd
# ユーザー環境変数に設定
setx GITHUB_TOKEN "ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"

# 新しいコマンドプロンプトを開いて確認
echo %GITHUB_TOKEN%
```

### 3. airc の実行

```bash
# 環境変数が設定されていれば、自動的に認証付きで実行される
airc

# または特定のプロジェクトを指定
airc -p default

# 強制上書き
airc --force
```

## ユースケース別の使用例

### ユースケース 1: 初めて Token を設定する

**シナリオ**: これまで Token なしで使っていたが、レート制限に引っかかるようになった

#### 手順

```bash
# 1. Token を生成（GitHub の Web UI で実行）
# 2. 環境変数に設定
export GITHUB_TOKEN="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"

# 3. Token が設定されたか確認
echo $GITHUB_TOKEN
# → ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx と表示されればOK

# 4. airc を実行
airc

# 出力例:
# 📦 プロジェクト: default
# 📂 リポジトリ: maru3460/airc
#
# ✅ .github/chatmodes/example.md
# ✅ .claude/instructions/basic.md
# ...
#
# ✨ 完了: 15ファイルをダウンロードしました
# 📊 GitHub API レート制限情報:
#    残り: 4985/5000 リクエスト (99%)
#    状態: ✅ 認証済み
```

### ユースケース 2: Token なしでも動作を確認

**シナリオ**: Token の設定が面倒なので、まずは Token なしで使いたい

#### 手順

```bash
# Token を設定せずに実行
airc

# 出力例:
# 📦 プロジェクト: default
# 📂 リポジトリ: maru3460/airc
#
# ✅ .github/chatmodes/example.md
# ...
#
# ✨ 完了: 15ファイルをダウンロードしました
# 📊 GitHub API レート制限情報:
#    残り: 45/60 リクエスト (75%)
#    状態: ⚠️  未認証
#
# 💡 ヒント: GITHUB_TOKEN 環境変数を設定すると、5,000リクエスト/時間まで使用できます
```

### ユースケース 3: レート制限に到達した場合

**シナリオ**: 短時間に何度も実行したら、レート制限に引っかかった

#### エラー例（Token なし）

```bash
airc

# エラー出力:
# ❌ エラー: GitHub API レート制限に到達しました。
#    リセット時刻: 2025-10-18 15:30:00
#    現在の制限: 60リクエスト/時間 (未認証)
#
# 💡 解決方法:
#    1. リセット時刻まで待つ（残り約45分）
#    2. GITHUB_TOKEN を設定して 5,000リクエスト/時間 に拡大
```

#### 解決方法

```bash
# Token を設定
export GITHUB_TOKEN="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"

# 再実行（すぐに使える）
airc

# 成功！
# ✅ .github/chatmodes/example.md
# ...
```

### ユースケース 4: 大規模プロジェクトでの使用

**シナリオ**: ファイル数が 100 個以上ある大規模プロジェクトを同期したい

#### Token ありの場合（推奨）

```bash
# Token を設定
export GITHUB_TOKEN="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"

# 大規模プロジェクトを同期
airc -p large-project

# 出力例:
# 📦 プロジェクト: large-project
# 📂 リポジトリ: maru3460/airc
#
# ✅ .github/chatmodes/file001.md
# ✅ .github/chatmodes/file002.md
# ...
# ✅ .claude/instructions/file150.md
#
# ✨ 完了: 150ファイルをダウンロードしました
# 📊 GitHub API レート制限情報:
#    残り: 4850/5000 リクエスト (97%)
#    状態: ✅ 認証済み
```

#### Token なしの場合（非推奨）

```bash
# Token なしで実行
airc -p large-project

# エラー発生（60リクエストを超えた時点で失敗）
# ⚠️  GitHub API レート制限: 残り 5/60 リクエスト (未認証)
#    リセット時刻: 2025-10-18 15:30:00
# ❌ エラー: GitHub API レート制限に到達しました。
```

### ユースケース 5: CI/CD での使用

**シナリオ**: GitHub Actions などの CI/CD 環境で airc を使いたい

#### GitHub Actions の設定例

```yaml
name: Sync AI Config

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install airc
        run: npm install -g @maru3460/airc

      - name: Sync AI config
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub が自動的に提供する Token
        run: airc --force

      - name: Commit changes
        run: |
          git config --local user.name "GitHub Actions"
          git config --local user.email "actions@github.com"
          git add .
          git commit -m "Update AI config" || echo "No changes to commit"
          git push
```

## トラブルシューティング

### 問題 1: Token が認識されない

```bash
# 環境変数の確認
echo $GITHUB_TOKEN
# → 何も表示されない場合は設定されていない

# 解決方法: 環境変数を設定
export GITHUB_TOKEN="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"

# 設定を永続化（~/.bashrc または ~/.zshrc に追加）
echo 'export GITHUB_TOKEN="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"' >> ~/.bashrc
source ~/.bashrc
```

### 問題 2: Token の形式が不正

```bash
airc

# エラー出力:
# ⚠️  GITHUB_TOKEN の形式が不正です
#    正しい形式: ghp_xxxx または github_pat_xxxx

# 解決方法: Token を再生成
# 1. GitHub で新しい Token を生成
# 2. 環境変数を更新
export GITHUB_TOKEN="ghp_新しいトークン"
```

### 問題 3: Token の権限が不足

```bash
airc

# エラー出力:
# ❌ エラー: GitHub API 認証エラー: GITHUB_TOKEN が無効です。
#    新しいトークンを生成してください。

# 解決方法:
# 1. Token が期限切れになっていないか確認
# 2. Token が正しくコピーされているか確認
# 3. 必要に応じて新しい Token を生成
```

### 問題 4: レート制限の警告が表示される

```bash
airc

# 警告出力:
# ⚠️  GitHub API レート制限: 残り 50/5000 リクエスト (認証済み)
#    リセット時刻: 2025-10-18 15:30:00

# 対処方法:
# 1. リセット時刻まで待つ
# 2. 別の GitHub アカウントの Token を使用
# 3. 頻繁に実行しすぎないよう注意
```

## ベストプラクティス

### 1. Token の安全な管理

```bash
# ❌ NGな例: コマンドラインで直接 Token を指定
airc --token ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# ✅ 推奨: 環境変数を使用
export GITHUB_TOKEN="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
airc
```

### 2. Token のスコープ最小化

- **Public リポジトリのみ**: スコープ不要（空でOK）
- **Private リポジトリも使う場合**: `repo` スコープのみ

### 3. Token の定期的なローテーション

```bash
# 90日ごとに Token を再生成することを推奨

# 古い Token を削除
unset GITHUB_TOKEN

# 新しい Token を設定
export GITHUB_TOKEN="ghp_新しいトークン"
```

### 4. 複数プロジェクトでの使い分け

```bash
# プロジェクトごとに異なる Token を使用する場合

# プロジェクトA用
export GITHUB_TOKEN_A="ghp_aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"

# プロジェクトB用
export GITHUB_TOKEN_B="ghp_bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb"

# 使い分け
GITHUB_TOKEN=$GITHUB_TOKEN_A airc -p project-a
GITHUB_TOKEN=$GITHUB_TOKEN_B airc -p project-b
```

## よくある質問（FAQ）

### Q1: Token を設定しないと使えないの？

**A**: いいえ、Token がなくても使えます。ただし、レート制限が 60リクエスト/時間 に制限されます。

### Q2: Token はどこに保存されるの？

**A**: 環境変数に設定されます。ファイルには保存されません（セキュリティのため）。

### Q3: Token の有効期限はどれくらい？

**A**: Token 生成時に選択できます。推奨は 90 days または No expiration です。

### Q4: Token が漏洩したらどうなるの？

**A**: GitHub で Token を無効化し、新しい Token を生成してください。
1. [Settings > Developer settings > Personal access tokens](https://github.com/settings/tokens) に移動
2. 漏洩した Token の **"Delete"** をクリック
3. 新しい Token を生成

### Q5: CI/CD で使う場合は？

**A**: GitHub Actions の場合、`${{ secrets.GITHUB_TOKEN }}` を使用してください（自動的に提供されます）。

## 次のステップ

- [概要](./概要.md): 機能の概要と目的
- [設計](./設計.md): 技術的な設計詳細
- [multi-source 機能](../multi-source/概要.md): 将来の拡張機能
